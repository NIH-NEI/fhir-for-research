<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>FHIR for Research - FHIR for Research Workshop - Bulk Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<!-- head.html -->
<!-- any content in this file is inserted into <head></head> -->

<script src="../../modules/mappings.js"></script>

<script>
// test if local storage is available and inititilize global variable store, code adapted from:
// https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
function initLocalStorage() {
  let storage;
  try {
    storage = window["localStorage"];
    const x = "__storage_test__";
    storage.setItem(x, x);
    storage.removeItem(x);
    return storage;
  } catch (e) {
    console.log("Error: local storage unavailable.");
    return (
      e instanceof DOMException &&
      // everything except Firefox
      (e.code === 22 ||
        // Firefox
        e.code === 1014 ||
        // test name field too, because code might not be present
        // everything except Firefox
        e.name === "QuotaExceededError" ||
        // Firefox
        e.name === "NS_ERROR_DOM_QUOTA_REACHED") &&
          // acknowledge QuotaExceededError only if there's something already stored
          storage &&
          storage.length !== 0
    );
  }
}

var store = initLocalStorage();
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">FHIR for Research</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../sections/overview.html" rel="" target="">
 <span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sections/working-with-data.html" rel="" target="">
 <span class="menu-text">Working With Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sections/advanced-topics.html" rel="" target="">
 <span class="menu-text">Advanced Topics</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../contribute.html" rel="" target="">
 <span class="menu-text">Contributions &amp; Corrections</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mitre/fhir-for-research" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#reference" id="toc-reference" class="nav-link active" data-scroll-target="#reference">Reference</a></li>
  <li><a href="#fetching-bulk-data-into-dataframes" id="toc-fetching-bulk-data-into-dataframes" class="nav-link" data-scroll-target="#fetching-bulk-data-into-dataframes">Fetching Bulk Data into DataFrames</a></li>
  <li><a href="#motivationpurpose" id="toc-motivationpurpose" class="nav-link" data-scroll-target="#motivationpurpose">Motivation/Purpose</a>
  <ul class="collapse">
  <li><a href="#icons-in-this-guide" id="toc-icons-in-this-guide" class="nav-link" data-scroll-target="#icons-in-this-guide">Icons in this Guide</a></li>
  </ul></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#step-1-getting-our-access-token" id="toc-step-1-getting-our-access-token" class="nav-link" data-scroll-target="#step-1-getting-our-access-token">Step 1: Getting our Access Token</a></li>
  <li><a href="#step-2-starting-checking-and-downloading-the-export" id="toc-step-2-starting-checking-and-downloading-the-export" class="nav-link" data-scroll-target="#step-2-starting-checking-and-downloading-the-export">Step 2: Starting, Checking, and Downloading the Export</a></li>
  <li><a href="#step-3-converting-to-dataframes" id="toc-step-3-converting-to-dataframes" class="nav-link" data-scroll-target="#step-3-converting-to-dataframes">Step 3: Converting to DataFrames</a></li>
  <li><a href="#step-4-bringing-it-all-together" id="toc-step-4-bringing-it-all-together" class="nav-link" data-scroll-target="#step-4-bringing-it-all-together">Step 4: Bringing it all together</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">FHIR for Research Workshop - Bulk Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="reference" class="level2">
<h2 class="anchored" data-anchor-id="reference">Reference</h2>
<ul>
<li><p><a href="http://hl7.org/fhir/uv/bulkdata/index.html" class="uri">http://hl7.org/fhir/uv/bulkdata/index.html</a></p></li>
<li><p><a href="http://www.hl7.org/fhir/smart-app-launch/backend-services.html" class="uri">http://www.hl7.org/fhir/smart-app-launch/backend-services.html</a></p></li>
</ul>
</section>
<section id="fetching-bulk-data-into-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="fetching-bulk-data-into-dataframes">Fetching Bulk Data into DataFrames</h2>
<p>The goal of this workshop is to connect to the SMART Bulk Data Server and fetch a set of sample patient data. While libraries like FHIR-PYrate https://github.com/UMEssen/FHIR-PYrate allow you to fetch data from a server and parse it directly into a DataFrame, these libraries generally do not support FHIR Bulk Data. This workshop will step through the process of building up a tool to fetch Bulk Data and convert it into DataFrames.</p>
</section>
<section id="motivationpurpose" class="level2">
<h2 class="anchored" data-anchor-id="motivationpurpose">Motivation/Purpose</h2>
<section id="icons-in-this-guide" class="level3">
<h3 class="anchored" data-anchor-id="icons-in-this-guide">Icons in this Guide</h3>
<p>📘 A link to a useful external reference related to the section the icon appears in</p>
<p>🖐 A hands-on section where you will code something or interact with the server</p>
</section>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The FHIR Bulk Data specification uses SMART Backend Authorization to connect. The basic idea of SMART Backend Authorization is that registered clients make a signed request to a token endpoint to receive a Bearer token, which is then used for subsequent calls to the FHIR server.</p>
<p>In practice, client registration is likely to happen as a separate one-time event performed manually. The SMART Backend Auth specification does not define an API for registration.</p>
<p>For this workshop, we are connecting to the SMART Bulk Data Server which allows clients to “register” using either a JWKS URL or by raw JWKS. (“registration” in this case is not stored on the server, instead they provide a base URL where that “registration” is stored as state in the URL and clientID). For convenience, the SMART Bulk Data Server launch page allows users to generate a once-off JWKS to use for testing. For production usage, clients must generate their own certificates and JWKS and keep the private key private. In this workshop we use a JWKS generated by the launch page with algorithm “RS384”.</p>
<p>IMPORTANT: this workshop largely skips error handling and stays on the “happy path” for brevity and readability. We strongly recommend reviewing the specifications and adding better error handling before using any of this code in a production environment.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The default style for rendering JSON (dictionaries) in Python isn't the best.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use this import and call print(json) when we want a cleaner view.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-1-getting-our-access-token" class="level2">
<h2 class="anchored" data-anchor-id="step-1-getting-our-access-token">Step 1: Getting our Access Token</h2>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First define our credentials</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client_id <span class="op">=</span> <span class="st">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InJlZ2lzdHJhdGlvbi10b2tlbiJ9.eyJqd2tzIjp7ImtleXMiOlt7Imt0eSI6IlJTQSIsImFsZyI6IlJTMzg0IiwibiI6IjNlLUx6cjJfRk5NQVRqZWpZa0Zqd1JxQTdWM3d6TnFMV25WODRjVGd5ZnlNVThvdjRERUk4S0V3cXpBZ0Q5U0ZzaW9FY2dLMjlDcE1tVHpYVy1lblFXYUc4Qk5qTjMxZ1NFNnBFLXpZMWdDOTFSclVjbGUzdENHYXVMeWlCS3JzOHA3WS0tekhLVVlaWjNLWmtUbldON2FFU0docGZQSlJvcUZ3V3BoZFBxc1dNUDdPZjVDUDFRMHJ3OTFaMXZ5TkdoV3l6YWNVd043WkJfVjVoVW1URE1Cb2FSXy1IMnp4YUVQVUZiaHVFU3R1QmozdmZURS10NE5RbWVNSmlaSkd1LVdiZHVMTWN2UzFNYlQwUzZiaEFEbUlHSW5tbkh0MnRlbVhUbXhaVWdTaERocHFaUHZ4alJfV0tZVW5uekM5S2lxaDNsT19lQUtObUV2Q0k1WjhqUSIsImUiOiJBUUFCIiwia2V5X29wcyI6WyJ2ZXJpZnkiXSwiZXh0Ijp0cnVlLCJraWQiOiIwOWEyZGRmMzljZWVmMGRmMDQ1ZDdmNGUzOTZjNzg1MSJ9LHsia3R5IjoiUlNBIiwiYWxnIjoiUlMzODQiLCJuIjoiM2UtTHpyMl9GTk1BVGplallrRmp3UnFBN1Yzd3pOcUxXblY4NGNUZ3lmeU1VOG92NERFSThLRXdxekFnRDlTRnNpb0VjZ0syOUNwTW1UelhXLWVuUVdhRzhCTmpOMzFnU0U2cEUtelkxZ0M5MVJyVWNsZTN0Q0dhdUx5aUJLcnM4cDdZLS16SEtVWVpaM0taa1RuV043YUVTR2hwZlBKUm9xRndXcGhkUHFzV01QN09mNUNQMVEwcnc5MVoxdnlOR2hXeXphY1V3TjdaQl9WNWhVbVRETUJvYVJfLUgyenhhRVBVRmJodUVTdHVCajN2ZlRFLXQ0TlFtZU1KaVpKR3UtV2JkdUxNY3ZTMU1iVDBTNmJoQURtSUdJbm1uSHQydGVtWFRteFpVZ1NoRGhwcVpQdnhqUl9XS1lVbm56QzlLaXFoM2xPX2VBS05tRXZDSTVaOGpRIiwiZSI6IkFRQUIiLCJkIjoiMWtQM0RscFNxS0F0bzFaRF94QnlablJZRk5LbE1LR3QtRi1GZWRMQjAwQm5tbDJSYXpqc0VLVU9mN2V1dkpuSm1nREcyZXVWQnBYdjdlRzNhWnQwOXNjdGI0cklOMEpzT21MM0NhMllpc09jZ3Ftc2dkZi1HNEoyQmZUWDF2bk9XVTdTM2lYekFmNFRlTFJEWHRvZjN4bnZESmtCZndmVG1OZVR5V05nWXFhdDM4VmJjTjFPMVJGNFhPMGk3RktUaVZ0Z3d2RzlLX2hHMXNrQkpMd0R0YXR3SGl6Z2ZJdERtRFMtbTQxaGRUSlFDZUptS3c0eGpJWDlWaXlpRXpsMTFxRmNrWUkzQUl2Q2toTkZMNVh5dkpuV0kyaHpmbTJxa1gzbTRXNEdKZVU0SV9Dbzl0dUd2SUNhZHJ0eFhQZjVWWk4tck5IemszRTVkbEZNNkRUdEFRIiwicCI6Ii1CR0NKaWF2V3ZiRE1SejZzd1lRc2ZEbTBBMnV0S3plZW82WDF0M3hBa0hCZ1pRajltZ25acFlVZEdvWW00NjFLSU1YUE54VWxfX0hWcWFuaUlNMjNvODlWTDJkMkJ1Z3UwcE5PbzhTcXdVNFROOVNIczBPOXUwVWZJRURzRVpPWWdDaDB1ZXBtMFMteG1QZ0F3UkxJTE10NmJUTFYyLVFtT1dHb2xjeno0ayIsInEiOiI1UWdpNjRTMEJaR2JobVJRYWFxc0YySFU5VllFM25Qck1GcHNJdmhvUzNRWEw5RFNOMEpQYWZ4VHVsMW9HS3hsV3FvRDkydks5YWNaVVpZWjU2SHZ4MFdWaGFzUWpGMERmd3NFMV8xRk1OTFppVy1xdVhGOGxRVjlEOHpHSkREYllXeEdOUDYtYkpXVWQycnM3MndtMzFDa3lrbUNsQmk5UWJ5SXRrM3FYLVUiLCJkcCI6ImVHWUhCUDFCbnFTbGxfQzR2S3IwNzJnOG5qNEZ6U3Naei1IbFVDUG9GWEJVdXM5cnBPeG9NeUlrUzF3ekZVenVIX3VBQzhua1JPR2ZuaTdFb1QwT0pIYmhEWF82WENrTW1kbzJJWFhQV2JIdTRXQ0NPdkRMa296LXBHNzVtMVNFTm95WF9nVHlES29RN2JrTHdHc1ZDNG5yZnNLQTdxNzNQejRuV2lONHdnRSIsImRxIjoiQ0pOemEwby15MjZXV2tQclZ1bVRKQlRfdW1nTUtxQkFrRUR5aDZTeGt4RzN4SXlYTW9hREhyN2FDOEp2b1d6akpxX3pFaEt4T04yVzd4MGx2eXlySTlVUk1qNGprbjN4SVpLeURieG9HTm5zVjE4ZEQzQ1diNllTOXNKLU1PQzdkanh0ckpKVll3OS16Ykh0U1ZITmF0TkVPR2JrUXROaVV0SFNkTEVhTTVrIiwicWkiOiJPR1JXYkJ4V2xncy05UUlsaEpFZEdPM0ZDb0FYREkyc3JTUlVwXzlnZVpXcGlxVTZHYUp0MjY4NzdKNHlGR0hhSG83MWN4eHpiOG55NTZCMTFiZm5DT3E2TUwtalI5Ym9RWmo1REhCaE1CYTZuVHI0anpfaE1uQjZqTFdMNFd3dGJwMkdpcXVMTVAyWnI2MGFSZHFJOVAzNlFadXMyVURGUmxLVmJrMlRLeFkiLCJrZXlfb3BzIjpbInNpZ24iXSwiZXh0Ijp0cnVlLCJraWQiOiIwOWEyZGRmMzljZWVmMGRmMDQ1ZDdmNGUzOTZjNzg1MSJ9XX0sImFjY2Vzc1Rva2Vuc0V4cGlyZUluIjoxNSwiaWF0IjoxNjgzOTAwNTEzfQ.OdAI3mUiBsEIF1ViZRyqOb6gpEg3HOxPjSB9kwf9R8w'</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>private_key <span class="op">=</span> <span class="st">"""-----BEGIN RSA PRIVATE KEY-----</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="st">MIIEowIBAAKCAQEA3e+Lzr2/FNMATjejYkFjwRqA7V3wzNqLWnV84cTgyfyMU8ov</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="st">4DEI8KEwqzAgD9SFsioEcgK29CpMmTzXW+enQWaG8BNjN31gSE6pE+zY1gC91RrU</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="st">cle3tCGauLyiBKrs8p7Y++zHKUYZZ3KZkTnWN7aESGhpfPJRoqFwWphdPqsWMP7O</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="st">f5CP1Q0rw91Z1vyNGhWyzacUwN7ZB/V5hUmTDMBoaR/+H2zxaEPUFbhuEStuBj3v</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="st">fTE+t4NQmeMJiZJGu+WbduLMcvS1MbT0S6bhADmIGInmnHt2temXTmxZUgShDhpq</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="st">ZPvxjR/WKYUnnzC9Kiqh3lO/eAKNmEvCI5Z8jQIDAQABAoIBAQDWQ/cOWlKooC2j</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="st">VkP/EHJmdFgU0qUwoa34X4V50sHTQGeaXZFrOOwQpQ5/t668mcmaAMbZ65UGle/t</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="st">4bdpm3T2xy1visg3Qmw6YvcJrZiKw5yCqayB1/4bgnYF9NfW+c5ZTtLeJfMB/hN4</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="st">tENe2h/fGe8MmQF/B9OY15PJY2Bipq3fxVtw3U7VEXhc7SLsUpOJW2DC8b0r+EbW</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="st">yQEkvAO1q3AeLOB8i0OYNL6bjWF1MlAJ4mYrDjGMhf1WLKITOXXWoVyRgjcAi8KS</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="st">E0UvlfK8mdYjaHN+baqRfebhbgYl5Tgj8Kj224a8gJp2u3Fc9/lVk36s0fOTcTl2</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="st">UUzoNO0BAoGBAPgRgiYmr1r2wzEc+rMGELHw5tANrrSs3nqOl9bd8QJBwYGUI/Zo</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="st">J2aWFHRqGJuOtSiDFzzcVJf/x1amp4iDNt6PPVS9ndgboLtKTTqPEqsFOEzfUh7N</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="st">DvbtFHyBA7BGTmIAodLnqZtEvsZj4AMESyCzLem0y1dvkJjlhqJXM8+JAoGBAOUI</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="st">IuuEtAWRm4ZkUGmqrBdh1PVWBN5z6zBabCL4aEt0Fy/Q0jdCT2n8U7pdaBisZVqq</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="st">A/dryvWnGVGWGeeh78dFlYWrEIxdA38LBNf9RTDS2YlvqrlxfJUFfQ/MxiQw22Fs</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="st">RjT+vmyVlHdq7O9sJt9QpMpJgpQYvUG8iLZN6l/lAoGAeGYHBP1BnqSll/C4vKr0</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="st">72g8nj4FzSsZz+HlUCPoFXBUus9rpOxoMyIkS1wzFUzuH/uAC8nkROGfni7EoT0O</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="st">JHbhDX/6XCkMmdo2IXXPWbHu4WCCOvDLkoz+pG75m1SENoyX/gTyDKoQ7bkLwGsV</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="st">C4nrfsKA7q73Pz4nWiN4wgECgYAIk3NrSj7LbpZaQ+tW6ZMkFP+6aAwqoECQQPKH</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="st">pLGTEbfEjJcyhoMevtoLwm+hbOMmr/MSErE43ZbvHSW/LKsj1REyPiOSffEhkrIN</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="st">vGgY2exXXx0PcJZvphL2wn4w4Lt2PG2sklVjD37Nse1JUc1q00Q4ZuRC02JS0dJ0</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="st">sRozmQKBgDhkVmwcVpYLPvUCJYSRHRjtxQqAFwyNrK0kVKf/YHmVqYqlOhmibduv</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="st">O+yeMhRh2h6O9XMcc2/J8uegddW35wjqujC/o0fW6EGY+QxwYTAWup06+I8/4TJw</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="st">eoy1i+FsLW6dhoqrizD9ma+tGkXaiPT9+kGbrNlAxUZSlW5NkysW</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="st">-----END RSA PRIVATE KEY-----</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>key_id <span class="op">=</span> <span class="st">"09a2ddf39ceef0df045d7f4e396c7851"</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># And server endpoint</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>server_url <span class="op">=</span> <span class="st">'https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZWwiOjB9/fhir'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we use the requests library to make all HTTP requests</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># and use a Session, in case we need to persist common settings such as proxy or SSL configuration</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>session <span class="op">=</span> requests.Session()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Turn off SSL verification. Useful when dealing with a corporate proxy with self-signed certificates.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib3.exceptions <span class="im">import</span> InsecureRequestWarning</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>requests.packages.urllib3.disable_warnings(category<span class="op">=</span>InsecureRequestWarning)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>session.verify <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's start by confirming we can even hit the server with the metadata endpoint</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/metadata'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> r.json()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'resourceType'</span>: <span style="color: #008000; text-decoration-color: #008000">'CapabilityStatement'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'status'</span>: <span style="color: #008000; text-decoration-color: #008000">'active'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'date'</span>: <span style="color: #008000; text-decoration-color: #008000">'2023-05-22T14:55:19+00:00'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher'</span>: <span style="color: #008000; text-decoration-color: #008000">"Boston Children's Hospital"</span>,
    <span style="color: #008000; text-decoration-color: #008000">'kind'</span>: <span style="color: #008000; text-decoration-color: #008000">'instance'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'instantiates'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/CapabilityStatement/bulk-data'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'software'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART Sample Bulk Data Server'</span>, <span style="color: #008000; text-decoration-color: #008000">'version'</span>: <span style="color: #008000; text-decoration-color: #008000">'2.1.1'</span><span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'implementation'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'description'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART Sample Bulk Data Server'</span><span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'fhirVersion'</span>: <span style="color: #008000; text-decoration-color: #008000">'4.0.1'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'acceptUnknown'</span>: <span style="color: #008000; text-decoration-color: #008000">'extensions'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'format'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'json'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'rest'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'mode'</span>: <span style="color: #008000; text-decoration-color: #008000">'server'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'security'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                            <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'token'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueUri'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/token'</span><span style="font-weight: bold">}</span>,
                            <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'register'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueUri'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/register'</span><span style="font-weight: bold">}</span>
                        <span style="font-weight: bold">]</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'service'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                            <span style="font-weight: bold">{</span>
                                <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/restful-security-service'</span>,
                                <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART-on-FHIR'</span>,
                                <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART-on-FHIR'</span>
                            <span style="font-weight: bold">}</span>
                        <span style="font-weight: bold">]</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'OAuth2 using SMART-on-FHIR profile (see http://docs.smarthealthit.org)'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'resource'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Patient'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                                <span style="font-weight: bold">{</span>
                                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                                    <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                                <span style="font-weight: bold">}</span>
                            <span style="font-weight: bold">]</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'patient-export'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/patient-export'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Group'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                                <span style="font-weight: bold">{</span>
                                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                                    <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                                <span style="font-weight: bold">}</span>
                            <span style="font-weight: bold">]</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'group-export'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/group-export'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'OperationDefinition'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'profile'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'reference'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/Profile/OperationDefinition'</span><span style="font-weight: bold">}</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'interaction'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'read'</span><span style="font-weight: bold">}]</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'searchParam'</span>: <span style="font-weight: bold">[]</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>,
            <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'get-resource-counts'</span>, <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'OperationDefinition/-s-get-resource-counts'</span><span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'export'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/export'</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For SMART Backend Auth, the token endpoint is published at .well-known/smart-configuration</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/.well-known/smart-configuration'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>smart_config <span class="op">=</span> r.json()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(smart_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/token'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'registration_endpoint'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/register'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint_auth_methods_supported'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'private_key_jwt'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint_auth_signing_alg_values_supported'</span>: <span style="font-weight: bold">[</span>
        <span style="color: #008000; text-decoration-color: #008000">'HS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'HS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'HS512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS512'</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'scopes_supported'</span>: <span style="font-weight: bold">[</span>
        <span style="color: #008000; text-decoration-color: #008000">'system/*.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Patient.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Encounter.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Condition.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Claim.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ExplanationOfBenefit.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Observation.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Immunization.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DiagnosticReport.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Procedure.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CareTeam.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CarePlan.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/MedicationRequest.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/AllergyIntolerance.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Device.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ImagingStudy.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Organization.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Practitioner.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DocumentReference.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Group.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/*.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Patient.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Encounter.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Condition.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Claim.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ExplanationOfBenefit.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Observation.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Immunization.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DiagnosticReport.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Procedure.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CareTeam.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CarePlan.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/MedicationRequest.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/AllergyIntolerance.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Device.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ImagingStudy.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Organization.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Practitioner.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DocumentReference.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Group.read'</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'capabilities'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'permission-v2'</span>, <span style="color: #008000; text-decoration-color: #008000">'permission-v1'</span>, <span style="color: #008000; text-decoration-color: #008000">'client-confidential-asymmetric'</span><span style="font-weight: bold">]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># There are a number of important fields here, but for now the one we care most about is the token_endpoint</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>token_endpoint <span class="op">=</span> smart_config[<span class="st">'token_endpoint'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now to get a token, we create a JWT client assertion as follows:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iss'</span>: client_id,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sub'</span>: client_id,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aud'</span>: token_endpoint,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>}, private_key, algorithm<span class="op">=</span><span class="st">'RS384'</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id}) <span class="co"># kid required for smart bulk data server</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># And post it to the token endpont</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.post(token_endpoint, data<span class="op">=</span>{</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>token_response <span class="op">=</span> r.json()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>token_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'token_type': 'bearer',
 'scope': 'system/*.read',
 'expires_in': 300,
 'access_token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYmVhcmVyIiwic2NvcGUiOiJzeXN0ZW0vKi5yZWFkIiwiZXhwaXJlc19pbiI6MzAwLCJpYXQiOjE2ODQ4NDQ0OTcsImV4cCI6MTY4NDg0NDc5N30.Fz5QcCl-DusftFOcgFtHRKUIFcXennLJI-hKPO8vm0k'}</code></pre>
</div>
</div>
<p>Two important fields we need to keep track of are the token itself, and the expire time. Tokens are only valid for a certain amount of time, and once they expire we will need to fetch a new one via the same process as above. <code>expires_in</code> is in seconds from the current time.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now to make this easier for ourselves, let's package this up into a function that we can call </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_token():</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> token, expire_time</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> datetime.datetime.now() <span class="op">&lt;</span> expire_time:</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the existing token is still valid so return it</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> token</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'iss'</span>: client_id,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sub'</span>: client_id,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'aud'</span>: token_endpoint,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    }, private_key, algorithm<span class="op">=</span><span class="st">'RS384'</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id})</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.post(token_endpoint, data<span class="op">=</span>{</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    token_response <span class="op">=</span> r.json()</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can reference get_token() and it will automatically fetch a new one whenever needed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-starting-checking-and-downloading-the-export" class="level2">
<h2 class="anchored" data-anchor-id="step-2-starting-checking-and-downloading-the-export">Step 2: Starting, Checking, and Downloading the Export</h2>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we make the export request</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/Patient/$export?_type=Patient,Condition'</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Prefer'</span>: <span class="st">'respond-async'</span>})</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.headers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Location'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/fhir/bulkstatus/b575c0b438735478317a8350b2cc5552'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Type'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'application/json; charset=utf-8'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'644'</span>, <span style="color: #008000; text-decoration-color: #008000">'Etag'</span>: <span style="color: #008000; text-decoration-color: #008000">'W/"284-+Rb1kGiUmlNav3GtsdCNxQbiFUc"'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:37 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>check_url <span class="op">=</span> r.headers[<span class="st">'Content-Location'</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>check_url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>'https://bulk-data.smarthealthit.org/fhir/bulkstatus/b575c0b438735478317a8350b2cc5552'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we check the status in a loop</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.get(check_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># There are three possible options here: http://hl7.org/fhir/uv/bulkdata/export.html#bulk-data-status-request</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error = 4xx or 5xx status code</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In-Progress = 202</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complete = 200</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># complete</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> r.json()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(response)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> r.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in progress</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r.headers)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        delay <span class="op">=</span> r.headers[<span class="st">'Retry-After'</span>]</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sleeping </span><span class="sc">{</span>delay<span class="sc">}</span><span class="ss"> seconds before retrying"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="bu">int</span>(delay))</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># error</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r.text)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'1% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:37 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'21% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:39 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'42% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:42 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'63% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:44 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'83% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 23 May 2023 12:21:46 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'transactionTime'</span>: <span style="color: #008000; text-decoration-color: #008000">'1684844497848'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'request'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZW</span>
<span style="color: #008000; text-decoration-color: #008000">wiOjB9/fhir/Patient/$export?_type=Patient,Condition'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'requiresAccessToken'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'output'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Condition'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'count'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">639</span>,
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJpZCI6ImI1NzVjMGI0Mzg3MzU0NzgzMTdhODM1MGIyY2M1NTUyIiwib2Zmc2V0IjowLCJsaW1pdC</span>
<span style="color: #008000; text-decoration-color: #008000">I6NjM5LCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Condition.ndjson'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Patient'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'count'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>,
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJpZCI6ImI1NzVjMGI0Mzg3MzU0NzgzMTdhODM1MGIyY2M1NTUyIiwib2Zmc2V0IjowLCJsaW1pdC</span>
<span style="color: #008000; text-decoration-color: #008000">I6MTAwLCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Patient.ndjson'</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'deleted'</span>: <span style="font-weight: bold">[]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'error'</span>: <span style="font-weight: bold">[]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> response[<span class="st">'output'</span>]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>output_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[{'type': 'Condition',
  'count': 639,
  'url': 'https://bulk-data.smarthealthit.org/eyJpZCI6ImI1NzVjMGI0Mzg3MzU0NzgzMTdhODM1MGIyY2M1NTUyIiwib2Zmc2V0IjowLCJsaW1pdCI6NjM5LCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Condition.ndjson'},
 {'type': 'Patient',
  'count': 100,
  'url': 'https://bulk-data.smarthealthit.org/eyJpZCI6ImI1NzVjMGI0Mzg3MzU0NzgzMTdhODM1MGIyY2M1NTUyIiwib2Zmc2V0IjowLCJsaW1pdCI6MTAwLCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Patient.ndjson'}]</code></pre>
</div>
</div>
<p>We can see that the reponse points us to one or more ndjson files per resource type. Now we can loop through the list and download each one. Each file is an NDJSON (Newline Delimited JSON) so that’s one resource per line. To make each step clear and distinct, we’ll keep a dict of <code>{ resourceType: [resources,...]}</code> which we can process later.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>resources_by_type <span class="op">=</span> {}</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> output_file <span class="kw">in</span> output_files:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    download_url <span class="op">=</span> output_file[<span class="st">'url'</span>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    resource_type <span class="op">=</span> output_file[<span class="st">'type'</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.get(download_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                                                   </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    ndjson <span class="op">=</span> r.text.strip()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> resources_by_type:</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        resources_by_type[resource_type] <span class="op">=</span> []</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDJSON can't be parsed as a whole, we have to process it line-by-line</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> ndjson.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        resource <span class="op">=</span> json.loads(line)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        resources_by_type[resource_type].append(resource)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a large amount of JSON data, only uncomment this line if you care to review</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># print(resources_by_type)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-converting-to-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="step-3-converting-to-dataframes">Step 3: Converting to DataFrames</h2>
<p>Finally, let’s convert these into DataFrames.</p>
<p>The quick-and-dirty option is to use the Pandas <code>json_normalize()</code> function to parse a list of <code>dict</code>s into a DataFrame.</p>
<p>📘 <a href="https://pandas.pydata.org/docs/reference/api/pandas.json_normalize.html">Read more about <code>pandas.json_normalize</code></a></p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>resource_dfs <span class="op">=</span> {}</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(resources)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we can work with them by type:</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">extension</th>
<th data-quarto-table-cell-role="th">identifier</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">telecom</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">birthDate</th>
<th data-quarto-table-cell-role="th">address</th>
<th data-quarto-table-cell-role="th">multipleBirthBoolean</th>
<th data-quarto-table-cell-role="th">communication</th>
<th data-quarto-table-cell-role="th">text.status</th>
<th data-quarto-table-cell-role="th">text.div</th>
<th data-quarto-table-cell-role="th">maritalStatus.coding</th>
<th data-quarto-table-cell-role="th">maritalStatus.text</th>
<th data-quarto-table-cell-role="th">multipleBirthInteger</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Patient</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Lemke', 'given...</td>
<td>[{'system': 'phone', 'value': '555-532-1156', ...</td>
<td>male</td>
<td>1965-01-13</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Patient</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Wintheiser', '...</td>
<td>[{'system': 'phone', 'value': '555-712-4709', ...</td>
<td>female</td>
<td>1971-04-05</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Patient</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Alaniz', 'give...</td>
<td>[{'system': 'phone', 'value': '555-446-6900', ...</td>
<td>male</td>
<td>1923-03-24</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Patient</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Walsh', 'given...</td>
<td>[{'system': 'phone', 'value': '555-436-4287', ...</td>
<td>female</td>
<td>1965-10-27</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Patient</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Bednar', 'give...</td>
<td>[{'system': 'phone', 'value': '555-405-4909', ...</td>
<td>female</td>
<td>1942-07-04</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>Patient</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Schmeler', 'gi...</td>
<td>[{'system': 'phone', 'value': '555-971-6300', ...</td>
<td>male</td>
<td>1995-10-19</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>Never Married</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>Patient</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Lubowitz', 'gi...</td>
<td>[{'system': 'phone', 'value': '555-328-5229', ...</td>
<td>male</td>
<td>1956-05-06</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>Patient</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Funk', 'given'...</td>
<td>[{'system': 'phone', 'value': '555-497-7639', ...</td>
<td>male</td>
<td>1966-02-07</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>Patient</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Bergstrom', 'g...</td>
<td>[{'system': 'phone', 'value': '555-845-1730', ...</td>
<td>male</td>
<td>1990-11-18</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>S</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>Patient</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Pagac', 'given...</td>
<td>[{'system': 'phone', 'value': '555-504-1379', ...</td>
<td>female</td>
<td>1968-04-20</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>S</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>100 rows × 16 columns</p>
</div>
</div>
</div>
<p>This works, but it’s clearly not ideal in how it handles nested fields. One way we can do a little better is with the flatten_json library: https://github.com/amirziai/flatten</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flatten_json <span class="im">import</span> flatten</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), resources)))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's take another look</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">text_status</th>
<th data-quarto-table-cell-role="th">text_div</th>
<th data-quarto-table-cell-role="th">extension_0_url</th>
<th data-quarto-table-cell-role="th">extension_0_valueString</th>
<th data-quarto-table-cell-role="th">extension_1_url</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_city</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_state</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_country</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">multipleBirthBoolean</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_system</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_code</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_display</th>
<th data-quarto-table-cell-role="th">communication_0_language_text</th>
<th data-quarto-table-cell-role="th">name_1_use</th>
<th data-quarto-table-cell-role="th">name_1_family</th>
<th data-quarto-table-cell-role="th">name_1_given_0</th>
<th data-quarto-table-cell-role="th">name_1_prefix_0</th>
<th data-quarto-table-cell-role="th">multipleBirthInteger</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Patient</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Lettie Boyle</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Boston</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Patient</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Marquetta Schamberger</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Macau</td>
<td>Macao Special Administrative Region of the Peo...</td>
<td>CN</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>zh</td>
<td>Chinese</td>
<td>Chinese</td>
<td>maiden</td>
<td>Heathcote</td>
<td>Aleta</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Patient</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Pilar Orta</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>San Jose</td>
<td>San Jose</td>
<td>CR</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>es</td>
<td>Spanish</td>
<td>Spanish</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Patient</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Arvilla Haag</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Norton</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>maiden</td>
<td>Kuphal</td>
<td>Alyce</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Patient</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Marcelina Harber</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Brockton</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>maiden</td>
<td>Runolfsson</td>
<td>Arnette</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>Patient</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Allison Daugherty</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Boston</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>Patient</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Antoinette Parker</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Mansfield</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>Patient</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Barbar Windler</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Randolph</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>Patient</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Juli Johns</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Holyoke</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>Patient</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Lanie Hyatt</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Millis</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>100 rows × 73 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Next, what if we know in advance we will only want certain fields? </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/beda-software/fhirpath-py</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fhirpathpy</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>fhir_paths<span class="op">=</span>[</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>],</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"gender"</span>, <span class="st">"gender"</span>],</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>],</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding[0].code"</span>]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>     f[<span class="dv">1</span>] <span class="op">=</span> fhirpathpy.<span class="bu">compile</span>(f[<span class="dv">1</span>])</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    filtered_resources <span class="op">=</span> []</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> resource <span class="kw">in</span> resources:</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        filtered_resource <span class="op">=</span> {}</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            fieldname <span class="op">=</span> f[<span class="dv">0</span>]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            func <span class="op">=</span> f[<span class="dv">1</span>]</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            filtered_resource[fieldname] <span class="op">=</span> func(resource)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(filtered_resource[fieldname], <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(filtered_resource[fieldname]) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                filtered_resource[fieldname] <span class="op">=</span> filtered_resource[fieldname][<span class="dv">0</span>]</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        filtered_resources.append(filtered_resource)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), filtered_resources)))</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">date_of_birth</th>
<th data-quarto-table-cell-role="th">marital_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>male</td>
<td>1965-01-13</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>female</td>
<td>1971-04-05</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>male</td>
<td>1923-03-24</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>female</td>
<td>1965-10-27</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>female</td>
<td>1942-07-04</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>male</td>
<td>1995-10-19</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>male</td>
<td>1956-05-06</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>male</td>
<td>1966-02-07</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>male</td>
<td>1990-11-18</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>female</td>
<td>1968-04-20</td>
<td>S</td>
</tr>
</tbody>
</table>

<p>100 rows × 4 columns</p>
</div>
</div>
</div>
</section>
<section id="step-4-bringing-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="step-4-bringing-it-all-together">Step 4: Bringing it all together</h2>
<p>Now we have everything we need. Let’s bring everything together from the previous steps into one class with a clear entrypoint</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fhirpathpy</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flatten_json <span class="im">import</span> flatten</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BulkDataFetcher:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        base_url: <span class="bu">str</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        client_id: <span class="bu">str</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        private_key: <span class="bu">str</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        key_id: <span class="bu">str</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        session <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.base_url <span class="op">=</span> base_url</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client_id <span class="op">=</span> client_id</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.private_key <span class="op">=</span> private_key</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key_id <span class="op">=</span> key_id</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_expire_time <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.session <span class="op">=</span> requests.Session()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.session <span class="op">=</span> session</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.get(<span class="ss">f'</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">/.well-known/smart-configuration'</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        smart_config <span class="op">=</span> r.json()</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_endpoint <span class="op">=</span> smart_config[<span class="st">'token_endpoint'</span>]</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resource_types <span class="op">=</span> []</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fhir_paths <span class="op">=</span> {}</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_token(<span class="va">self</span>):</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.token <span class="kw">and</span> datetime.datetime.now() <span class="op">&lt;</span> <span class="va">self</span>.expire_time:</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the existing token is still valid so </span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.token</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>        assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">'iss'</span>: <span class="va">self</span>.client_id,</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sub'</span>: <span class="va">self</span>.client_id,</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">'aud'</span>: <span class="va">self</span>.token_endpoint,</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>        }, <span class="va">self</span>.private_key, algorithm<span class="op">=</span><span class="st">'RS384'</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id})</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.post(<span class="va">self</span>.token_endpoint, data<span class="op">=</span>{</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        token_response <span class="op">=</span> r.json()</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.token</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_resource_type(<span class="va">self</span>, resource_type: <span class="bu">str</span>, fhir_paths <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resource_types.append(resource_type)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fhir_paths:</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># fhir_paths=[</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>            <span class="co">#    ("id", "identifier[0].value"),</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>            <span class="co">#    ("marital_status", "maritalStatus.coding[0].code")</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ]</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            compiled_fhir_paths <span class="op">=</span> [(f[<span class="dv">0</span>], fhirpathpy.<span class="bu">compile</span>(f[<span class="dv">1</span>])) <span class="cf">for</span> f <span class="kw">in</span> fhir_paths]</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.fhir_paths[resource_type] <span class="op">=</span> compiled_fhir_paths</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _invoke_request(<span class="va">self</span>):</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        types <span class="op">=</span> <span class="st">','</span>.join(<span class="va">self</span>.resource_types)</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.get(<span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>base_url<span class="sc">}</span><span class="ss">/Patient/$export?_type=</span><span class="sc">{</span>types<span class="sc">}</span><span class="ss">'</span>, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>, <span class="st">'Prefer'</span>: <span class="st">'respond-async'</span>})</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.check_url <span class="op">=</span> r.headers[<span class="st">'Content-Location'</span>]</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.check_url</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _wait_until_ready(<span class="va">self</span>):</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> <span class="va">self</span>.session.get(<span class="va">self</span>.check_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>            <span class="co"># There are three possible options here: http://hl7.org/fhir/uv/bulkdata/export.html#bulk-data-status-request</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Error = 4xx or 5xx status code</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># In-Progress = 202</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Complete = 200</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> r.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>                <span class="co"># complete</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>                response <span class="op">=</span> r.json()</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.output_files <span class="op">=</span> response[<span class="st">'output'</span>]</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.output_files</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> r.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>                <span class="co"># in progress</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>                delay <span class="op">=</span> r.headers[<span class="st">'Retry-After'</span>]</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>                sleep(<span class="bu">int</span>(delay))</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">RuntimeError</span>(r.text)</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_dataframe(<span class="va">self</span>):</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._invoke_request()</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._wait_until_ready()</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>        resources_by_type <span class="op">=</span> {}</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> output_file <span class="kw">in</span> <span class="va">self</span>.output_files:</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>            download_url <span class="op">=</span> output_file[<span class="st">'url'</span>]</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>            resource_type <span class="op">=</span> output_file[<span class="st">'type'</span>]</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> <span class="va">self</span>.session.get(download_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>            ndjson <span class="op">=</span> r.text.strip()</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> resources_by_type:</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>                resources_by_type[resource_type] <span class="op">=</span> []</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> ndjson.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>                resource <span class="op">=</span> json.loads(line)</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> resource_type <span class="kw">in</span> <span class="va">self</span>.fhir_paths:</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>                    fhir_paths <span class="op">=</span> <span class="va">self</span>.fhir_paths[resource_type]</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>                    filtered_resource <span class="op">=</span> {}</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>                        fieldname <span class="op">=</span> f[<span class="dv">0</span>]</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>                        func <span class="op">=</span> f[<span class="dv">1</span>]</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>                        filtered_resource[fieldname] <span class="op">=</span> func(resource)</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(filtered_resource[fieldname], <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(filtered_resource[fieldname]) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>                            filtered_resource[fieldname] <span class="op">=</span> filtered_resource[fieldname][<span class="dv">0</span>]</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>                    resource <span class="op">=</span> filtered_resource</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>                resources_by_type[resource_type].append(resource)</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> {}</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>            dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), resources)))</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dfs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># And then to invoke it:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>fetcher <span class="op">=</span> BulkDataFetcher(server_url, client_id, private_key, key_id, session)                </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Patient'</span>, [</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"gender"</span>, <span class="st">"gender"</span>),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding[0].code"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Condition'</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> fetcher.get_dataframe()</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">date_of_birth</th>
<th data-quarto-table-cell-role="th">marital_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>male</td>
<td>1965-01-13</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>female</td>
<td>1971-04-05</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>male</td>
<td>1923-03-24</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>female</td>
<td>1965-10-27</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>female</td>
<td>1942-07-04</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>male</td>
<td>1995-10-19</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>male</td>
<td>1956-05-06</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>male</td>
<td>1966-02-07</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>male</td>
<td>1990-11-18</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>female</td>
<td>1968-04-20</td>
<td>S</td>
</tr>
</tbody>
</table>

<p>100 rows × 4 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Condition'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">clinicalStatus_coding_0_system</th>
<th data-quarto-table-cell-role="th">clinicalStatus_coding_0_code</th>
<th data-quarto-table-cell-role="th">verificationStatus_coding_0_system</th>
<th data-quarto-table-cell-role="th">verificationStatus_coding_0_code</th>
<th data-quarto-table-cell-role="th">code_coding_0_system</th>
<th data-quarto-table-cell-role="th">code_coding_0_code</th>
<th data-quarto-table-cell-role="th">code_coding_0_display</th>
<th data-quarto-table-cell-role="th">code_text</th>
<th data-quarto-table-cell-role="th">subject_reference</th>
<th data-quarto-table-cell-role="th">encounter_reference</th>
<th data-quarto-table-cell-role="th">onsetDateTime</th>
<th data-quarto-table-cell-role="th">recordedDate</th>
<th data-quarto-table-cell-role="th">abatementDateTime</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Condition</td>
<td>a5a38601-b6fe-46b4-a67e-cde9d5957dde</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>40055000</td>
<td>Chronic sinusitis (disorder)</td>
<td>Chronic sinusitis (disorder)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/17b801ac-58e3-4f6b-8b48-8e33f3a36086</td>
<td>1985-06-18T17:30:49-04:00</td>
<td>1985-06-18T17:30:49-04:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Condition</td>
<td>8f818ad4-c292-47e8-8d99-c4c54174b671</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>162864005</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/0953dd44-90bb-4805-badd-169a761a6ab3</td>
<td>2005-01-19T16:30:49-05:00</td>
<td>2005-01-19T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Condition</td>
<td>65d9d5f2-a772-4586-932f-df1f2ce1a863</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>15777000</td>
<td>Prediabetes</td>
<td>Prediabetes</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/d4e1370a-a679-4570-a3dc-e4f7ac847512</td>
<td>2013-02-06T16:30:49-05:00</td>
<td>2013-02-06T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Condition</td>
<td>77ac8342-6950-4302-a303-efba12e06785</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>68496003</td>
<td>Polyp of colon</td>
<td>Polyp of colon</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/58ad433b-3707-4d40-9b63-2a803b4913bd</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2017-05-03T17:30:49-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Condition</td>
<td>6514ab0c-bc64-4e1b-aa61-b97d27d72bc7</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>271737000</td>
<td>Anemia (disorder)</td>
<td>Anemia (disorder)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/58ad433b-3707-4d40-9b63-2a803b4913bd</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">634</td>
<td>Condition</td>
<td>ab051f6c-4298-407b-9315-2322ce913539</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>162864005</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/c5ed8aed-2b7e-4630-bd1d-ac5090967edc</td>
<td>2014-11-22T15:43:42-05:00</td>
<td>2014-11-22T15:43:42-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">635</td>
<td>Condition</td>
<td>76c1f07a-f8f2-4705-aa80-5f7a25d7c651</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>39848009</td>
<td>Whiplash injury to neck</td>
<td>Whiplash injury to neck</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/9c8b41dd-d6fd-4691-ae46-01b47992dd8d</td>
<td>2015-07-13T16:43:42-04:00</td>
<td>2015-07-13T16:43:42-04:00</td>
<td>2015-08-10T16:43:42-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">636</td>
<td>Condition</td>
<td>b9a078eb-bb83-49ed-b4ed-633d1445356d</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>70704007</td>
<td>Sprain of wrist</td>
<td>Sprain of wrist</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/f044f05a-8433-4952-926d-dd8e2b4ee44e</td>
<td>2018-07-25T16:43:42-04:00</td>
<td>2018-07-25T16:43:42-04:00</td>
<td>2018-08-15T16:43:42-04:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">637</td>
<td>Condition</td>
<td>0fe427ce-7ea1-4409-8de1-3879f9dc56bb</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>444814009</td>
<td>Viral sinusitis (disorder)</td>
<td>Viral sinusitis (disorder)</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/9100e9aa-1206-403b-b2bf-b75ac23991bd</td>
<td>2018-09-26T16:43:42-04:00</td>
<td>2018-09-26T16:43:42-04:00</td>
<td>2018-10-17T16:43:42-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">638</td>
<td>Condition</td>
<td>88f3f41a-68ec-46dd-8d44-9178d3872220</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>72892002</td>
<td>Normal pregnancy</td>
<td>Normal pregnancy</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/2d975caf-e6bf-43c2-8778-ea293df1f255</td>
<td>2018-12-22T15:43:42-05:00</td>
<td>2018-12-22T15:43:42-05:00</td>
<td>2019-07-27T16:43:42-04:00</td>
</tr>
</tbody>
</table>

<p>639 rows × 15 columns</p>
</div>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Through this exercise we built a reusable tool to connect to a FHIR server with Bulk Data capabilities, export a set of resource types, and convert that data into DataFrames for analysis.</p>


</section>

</main> <!-- /main -->
<!-- scripts.html -->
<!-- any content in this file is inserted right before </body> -->

<!-- fancy json code viewer -->
<script type="text/javascript" src="https://unpkg.com/dompurify@3.0.1/dist/purify.min.js"></script> <!-- load JS Sanitizer -->
<script>
    function jsonViewer(json, collapsible=false) {
        let TEMPLATES = {
            item: '<div class="json_view__item"><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--%TYPE%">%VALUE%</div></div>',
            itemCollapsible: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>',
            itemCollapsibleOpen: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" checked class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>'
        };

        function createItem(key, value, type){
            let element = TEMPLATES.item.replace('%KEY%', key);

            if((key == 'div') && (type=='string')) { // Removes Resource.text.div value (looks bloated)
                element = element.replace('%VALUE%', '...');
            } else if(type == 'string') {
                element = element.replace('%VALUE%', '"' + value + '"');
            } else {
                element = element.replace('%VALUE%', value);
            }

            element = element.replace('%TYPE%', type);

            return element;
        }

        function createCollapsibleItem(key, value, type, children){
            let tpl = 'itemCollapsible';

            if(collapsible) {
                tpl = 'itemCollapsibleOpen';
            }

            let element = TEMPLATES[tpl].replace('%KEY%', key);

            element = element.replace('%VALUE%', type);
            element = element.replace('%TYPE%', type);
            element = element.replace('%CHILDREN%', children);

            return element;
        }

        function handleChildren(key, value, type) {
            let html = '';

            for(let item in value) {
                let _key = item,
                    _val = value[item];

                html += handleItem(_key, _val);
            }

            return createCollapsibleItem(key, value, type, html);
        }

        function handleItem(key, value) {
            let type = typeof value;

            if( Array.isArray( value ) ) {
                return handleChildren(key, value, "array");
            }

            if(typeof value === 'object') {
                return handleChildren(key, value, type);
            }

            return createItem(key, value, type);
        }

        function parseObject(obj) {
            _result = '<div class="json_view">';

            for(let item in obj) {
                let key = item,
                    value = obj[item];

                _result += handleItem(key, value);
            }

            _result += '</div>';

            return _result;
        }

        try {
            return parseObject(JSON.parse(json));
        }
        catch(err) {
            console.log("Could not render JSON viewer: ", err);
            console.log("for string: ", json);
            return null;
        }

    };


    function parseHTML(string) {
        let sanitized = DOMPurify.sanitize(string);
        let parser = new DOMParser();
        return parser.parseFromString(sanitized, "text/html").body.firstChild;
    }

    let jsonCodeBlocks = document.querySelectorAll("code.sourceCode.json");
    jsonCodeBlocks.forEach((jsonCode) => {
        let json = jsonCode.innerText;
        let codeBlock = jsonCode.parentNode.parentNode;
        let uid = codeBlock.id;
        let documentLocation = codeBlock.parentNode;
        let viewerHTML = jsonViewer(json, true);

        let tabContainer = parseHTML(`
          <div>
            <ul class="nav nav-tabs" id="${uid}Tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="${uid}ViewerTab" data-bs-toggle="tab" data-bs-target="#${uid}Viewer" type="button" role="tab" aria-controls="${uid}Viewer" aria-selected="true">Viewer</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="${uid}JsonTab" data-bs-toggle="tab" data-bs-target="#${uid}Json" type="button" role="tab" aria-controls="${uid}Json" aria-selected="false">JSON</button>
              </li>
            </ul>
            <div class="tab-content" id="${uid}TabContent" style="height:50vh;overflow:scroll;">
              <div class="tab-pane fade show active" id="${uid}Viewer" role="tabpanel" aria-labelledby="${uid}ViewerTab"></div>
              <div class="tab-pane fade" id="${uid}Json" role="tabpanel" aria-labelledby="${uid}JsonTab"></div>
            </div>
          </div>
        `)

        if( viewerHTML != null ) {
            documentLocation.replaceChild(tabContainer, codeBlock);

            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Viewer`).appendChild( parseHTML(viewerHTML) );
            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Json`).appendChild(codeBlock);
        }
    });
</script>

<script>
// Below function is usable by CC BY-SA 3.0 from https://stackoverflow.com/a/6475125
String.prototype.toTitleCase = function() {
  let i, j, str, lowers, uppers;
  str = this.replace(/([^\W_]+[^\s-]*) */g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });

  // Certain minor words should be left lowercase unless
  // they are the first or last words in the string
  lowers = ['A', 'An', 'The', 'And', 'But', 'Or', 'For', 'Nor', 'As', 'At',
  'By', 'For', 'From', 'In', 'Into', 'Near', 'Of', 'On', 'Onto', 'To', 'With'];
  for (i = 0, j = lowers.length; i < j; i++)
    str = str.replace(new RegExp('\\s' + lowers[i] + '\\s', 'g'),
      function(txt) {
        return txt.toLowerCase();
      });

  // Certain words such as initialisms or acronyms should be left uppercase
  uppers = ['ID', 'TV', 'FHIR'];
  for (i = 0, j = uppers.length; i < j; i++)
    str = str.replace(new RegExp('\\b' + uppers[i] + '\\b', 'g'),
      uppers[i].toUpperCase());

  return str;
}

// Custom Hack to overwrite Quarto's built in navigators
document.addEventListener("DOMContentLoaded", function() {
    // Get current module and role
    const current_module_slug = window.location.toString().split('/').pop().split('.')[0];
    const role = store.getItem("role");

    //console.log("DEBUG: current module:", current_module, "role: ", role);

    // Get next and prev modules data
    let prev_href, prev_text;
    let next_href, next_text;
    role_module_map.forEach((mapping) => {
        if( mapping.role == role ) {
            for(let i=0; i<mapping.modules.length; i++) {
                if( mapping.modules[i].slug == current_module_slug ) {
                    function slug_to_url(slug) {
                        if( window.location.path.includes('modules') ) {
                            // replace "modules/*" in current URL with "modules/<slug>.html"
                            return window.location.toString().replace(/modules\/.*/, "modules/" + slug + ".html");
                        }
                        else {
                            // this case is irrelevant since prev/next buttons are only role-based in modules
                            return window.location.toString() + "/modules/" + slug + ".html";
                        }
                    }

                    prev_href = (i > 0) ? slug_to_url(mapping.modules[i-1].slug) : null;
                    prev_text = (i > 0) ? mapping.modules[i-1].text : null;

                    next_href = (i+1 < mapping.modules.length) ? slug_to_url(mapping.modules[i+1].slug) : null;
                    next_text = (i+1 < mapping.modules.length) ? mapping.modules[i+1].text : null;

                    console.log("DEBUG 2");

                }
            }
        }
    });

    // Overwrite prev link
    if( prev_href ) {
        const prev_link_elmt = document.querySelector(".page-navigation .nav-page-previous .pagination-link");
        const prev_text_elmt = document.querySelector(".page-navigation .nav-page-previous .pagination-link .nav-page-text");
        if( prev_link_elmt ) {


            console.log("DEBUG 3");

            prev_link_elmt.href = prev_href
            //prev_link_elmt.classList.add("btn", "btn-outline-custom", "rounded");
            //prev_link_elmt.parentNode.classList.toggle("nav-page");
            prev_text_elmt.innerText = prev_text;
        }
    }

    // Overwrite next link
    if( next_href ) {
        const next_link_elmt = document.querySelector(".page-navigation .nav-page-next .pagination-link");
        const next_text_elmt = document.querySelector(".page-navigation .nav-page-next .pagination-link .nav-page-text");

        console.log("DEBUG 4");

        if( next_link_elmt ) {
            next_link_elmt.href = next_href;
            //next_link_elmt.classList.add("btn", "btn-outline-custom", "rounded");
            //next_link_elmt.parentNode.classList.toggle("nav-page");
            next_text_elmt.innerText = next_text;
        }
    }

    // if document has #key-points then move pagination to next after it
    key_points = document.querySelector("#key-points");
    if( key_points ) {
        let page_nav = document.querySelector("nav.page-navigation");
        key_points.insertAdjacentElement("afterend", page_nav);
    }

    console.log("DEBUG 10");

});


// Override style of Quarto page navigation (prev/next buttons)
document.addEventListener("DOMContentLoaded", function() {

    console.log("DEBUG 20");

    const page_navigators = document.querySelectorAll(".pagination-link");
    page_navigators.forEach((node) => {
        console.log("DEBUG 21");

        node.classList.add("btn", "btn-outline-custom", "rounded");
        node.parentNode.classList.remove("nav-page");
        node.parentNode.parentNode.style.gridRow = "initial";
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2023 The MITRE Corporation / <a href="https://github.com/mitre/fhir-for-research/README.md">License information</a><br>Approved for Public Release / Case #23-0966
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>